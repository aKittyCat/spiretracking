<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="env.js"></script>
    <script src="supabase-config.js"></script>
    <title>The Spire Tracking - ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #111827;
        }

        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }

        .glass-panel {
            background: rgba(31, 41, 55, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(75, 85, 99, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-btn {
            position: relative;
            transition: all 0.3s ease;
        }

        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0%;
            height: 2px;
            background: currentColor;
            transition: width 0.3s ease;
        }

        .tab-btn.active::after {
            width: 100%;
        }

        .input-primary {
            background-color: rgba(17, 24, 39, 0.6);
            border: 1px solid #374151;
            color: #e5e7eb;
            transition: all 0.2s;
        }

        .input-primary:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
            outline: none;
        }
    </style>
</head>

<body class="bg-gray-950 text-gray-200 min-h-screen selection:bg-indigo-500 selection:text-white pb-10">

    <div class="max-w-[1280px] mx-auto p-4 sm:p-6 lg:p-8">

        <div class="flex flex-col md:flex-row justify-between items-center mb-6 pb-6 border-b border-gray-800 gap-4">
            <div class="flex items-center gap-4">
                <a href="characters.html"
                    class="p-3 bg-gray-800/50 hover:bg-gray-800 rounded-xl border border-gray-700 transition group"
                    title="‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£">
                    <i class="fa-solid fa-arrow-left text-gray-400 group-hover:text-white"></i>
                </a>
                <button onclick="manualRefresh()" id="btnRefresh"
                    class="p-3 bg-gray-800/50 hover:bg-gray-800 rounded-xl border border-gray-700 transition group"
                    title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î">
                    <i id="refreshIcon" class="fa-solid fa-arrows-rotate text-gray-400 group-hover:text-white"></i>
                </button>
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-white tracking-tight flex items-center gap-2">
                        üìú ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
                    </h1>
                    <p class="text-xs text-gray-500 mt-1">Manage your character stats and logs</p>
                </div>
            </div>

            <div class="flex items-center gap-3 bg-gray-900/50 p-2 rounded-xl border border-gray-800">
                <div class="px-3 flex flex-col items-end">
                    <span class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Logged in as</span>
                    <span id="userEmail" class="text-sm font-medium text-gray-300">...</span>
                </div>
                <button onclick="logout()"
                    class="bg-rose-600/10 hover:bg-rose-600 text-rose-500 hover:text-white p-2 rounded-lg transition-all duration-300 border border-rose-600/20"
                    title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" x2="9" y1="12" y2="12" />
                    </svg>
                </button>
            </div>
        </div>

        <div id="charInfo" class="glass-panel p-6 rounded-2xl shadow-xl mb-8 relative overflow-hidden group">
            <div
                class="absolute top-0 right-0 w-96 h-96 bg-indigo-600/10 rounded-full blur-3xl -z-10 group-hover:bg-indigo-600/15 transition duration-1000">
            </div>

            <div class="flex flex-col lg:flex-row gap-8 items-stretch">
                <div
                    class="lg:w-1/3 flex flex-col justify-between border-b lg:border-b-0 lg:border-r border-gray-700/50 pb-6 lg:pb-0 lg:pr-8">
                    <div>
                        <div class="flex justify-between items-start mb-4">
                            <span id="charTier"
                                class="px-3 py-1 bg-gray-800/80 text-gray-300 border border-gray-600 rounded-lg text-[10px] font-bold uppercase tracking-wider shadow-sm backdrop-blur-sm">TIER
                                ?</span>
                            <button onclick="editCharacter()"
                                class="text-gray-400 hover:text-white bg-gray-800/50 hover:bg-gray-700 p-2 rounded-lg transition border border-transparent hover:border-gray-600"
                                title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                        </div>

                        <div class="mb-5">
                            <h2 class="text-4xl font-bold text-white tracking-tight mb-2 leading-none" id="charName">...
                            </h2>
                            <div class="flex items-center gap-2 text-sm text-gray-400">
                                <span id="charRace" class="text-indigo-300 font-medium">...</span>
                                <span class="w-1 h-1 bg-gray-600 rounded-full"></span>
                                <span id="charClass">...</span>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-2">
                            <span id="charAlignment"
                                class="px-3 py-1.5 rounded-lg bg-gray-800/50 border border-gray-700 text-xs text-gray-400 font-medium">Neutral</span>
                            <a id="sheetLink" href="#" target="_blank"
                                class="px-3 py-1.5 rounded-lg bg-blue-600/10 border border-blue-600/30 text-blue-400 text-xs font-medium hover:bg-blue-600 hover:text-white transition flex items-center gap-2 group/link">
                                <i class="fa-solid fa-scroll group-hover/link:rotate-12 transition-transform"></i> Sheet
                            </a>
                        </div>
                    </div>

                    <div class="mt-6 pt-4 border-t border-gray-800/50">
                        <div
                            class="flex items-center gap-2 text-[10px] text-gray-500 uppercase font-bold tracking-wide mb-1">
                            <i class="fa-solid fa-paw"></i> Companion
                        </div>
                        <p id="charPets" class="text-gray-300 text-sm">None</p>
                    </div>
                </div>

                <div class="lg:w-2/3 grid grid-cols-2 sm:grid-cols-4 gap-4">

                    <div
                        class="bg-gray-800/30 rounded-xl border border-gray-700/50 p-4 flex flex-col items-center justify-center text-center relative overflow-hidden group/card hover:bg-gray-800/50 transition duration-300">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-transparent opacity-0 group-hover/card:opacity-100 transition">
                        </div>
                        <span class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-2">Level</span>
                        <span id="charCurrentLevel" class="text-4xl font-bold text-white leading-none mb-2">0</span>
                        <span
                            class="text-[10px] text-blue-300 bg-blue-500/10 px-2 py-0.5 rounded-full border border-blue-500/20 whitespace-nowrap">
                            Next: <span id="charHoursToLevelUp">0</span> hrs
                        </span>
                    </div>

                    <div
                        class="bg-gray-800/30 rounded-xl border border-gray-700/50 p-4 flex flex-col items-center justify-center text-center relative overflow-hidden group/card hover:bg-gray-800/50 transition duration-300">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-yellow-500/5 to-transparent opacity-0 group-hover/card:opacity-100 transition">
                        </div>
                        <span class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-2">Gold</span>
                        <div class="flex items-baseline gap-1 mb-2">
                            <span id="charTotalGold" class="text-3xl font-bold text-yellow-400 leading-none">0</span>
                            <span class="text-[10px] text-yellow-600 font-bold">GP</span>
                        </div>
                        <span
                            class="text-[10px] text-gray-500 bg-gray-900/50 px-2 py-0.5 rounded border border-gray-700">‡∏ó‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:
                            <span id="charGoldStart">0</span></span>
                    </div>

                    <div
                        class="bg-gray-800/30 rounded-xl border border-gray-700/50 p-4 flex flex-col items-center justify-center text-center relative overflow-hidden group/card hover:bg-gray-800/50 transition duration-300">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-purple-500/5 to-transparent opacity-0 group-hover/card:opacity-100 transition">
                        </div>
                        <span class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-2">Favor</span>
                        <span id="charTotalFavor" class="text-3xl font-bold text-purple-400 leading-none mb-2">0</span>
                        <span class="text-[10px] text-purple-400/40 font-medium">Points</span>
                    </div>

                    <div
                        class="bg-gray-800/30 rounded-xl border border-gray-700/50 p-4 flex flex-col items-center justify-center text-center relative overflow-hidden group/card hover:bg-gray-800/50 transition duration-300">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-green-500/5 to-transparent opacity-0 group-hover/card:opacity-100 transition">
                        </div>
                        <span class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-2">Playtime</span>
                        <div class="flex items-baseline gap-1 mb-2">
                            <span id="charTotalHours" class="text-3xl font-bold text-green-400 leading-none">0</span>
                            <span class="text-[10px] text-green-600 font-bold">Hrs</span>
                        </div>
                        <span class="text-[10px] text-gray-500">Total Hours</span>
                        <span class="text-[10px] text-green-300/60">(<span id="charTotalHoursPlus">0</span>)</span>
                    </div>

                </div>
            </div>
        </div>

        <div class="flex mb-6 border-b border-gray-800 overflow-x-auto pb-1 scrollbar-hide gap-6 px-2">
            <button onclick="openTab('session')" id="tab-session"
                class="tab-btn active whitespace-nowrap py-3 font-medium text-gray-400 hover:text-white flex items-center gap-2">
                <i class="fa-solid fa-gamepad"></i> Sessions
            </button>
            <button onclick="openTab('gold')" id="tab-gold"
                class="tab-btn whitespace-nowrap py-3 font-medium text-yellow-400 hover:text-yellow-300 flex items-center gap-2">
                <i class="fa-solid fa-coins"></i> Gold Logs
            </button>
            <button onclick="openTab('favor')" id="tab-favor"
                class="tab-btn whitespace-nowrap py-3 font-medium text-purple-400 hover:text-purple-300 flex items-center gap-2">
                <i class="fa-solid fa-star"></i> Favor Logs
            </button>
            <button onclick="openTab('dm')" id="tab-dm"
                class="tab-btn whitespace-nowrap py-3 font-medium text-red-400 hover:text-red-300 flex items-center gap-2">
                <i class="fa-solid fa-dungeon"></i> DM Logs
            </button>
            <button onclick="openTab('char-notes')" id="tab-char-notes"
                class="tab-btn whitespace-nowrap py-3 font-medium text-blue-300 hover:text-blue-400 flex items-center gap-2">
                <i class="fa-solid fa-book"></i> Notes
            </button>
        </div>

        <div id="session" class="tab-content active">
            <div class="glass-panel p-6 rounded-2xl shadow-lg mb-8" id="sessionFormCard">
                <h2 class="text-lg font-bold mb-5 text-white flex items-center gap-2">
                    <span class="bg-blue-600/20 text-blue-400 p-1.5 rounded-lg text-sm"><i
                            class="fa-solid fa-plus"></i></span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô (Session)
                    <button id="btnBulkImport" onclick="openBulkImportModal()"
                        class="hidden ml-2 p-1.5 rounded-lg bg-indigo-600/15 hover:bg-indigo-600/30 border border-indigo-500/30 hover:border-indigo-500/50 text-indigo-400 hover:text-indigo-300 transition-all duration-200 group/bulk"
                        title="‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Session ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ß‡∏≤‡∏á‡∏à‡∏≤‡∏Å Sheet)">
                        <i
                            class="fa-solid fa-clipboard-list text-sm group-hover/bulk:scale-110 transition-transform"></i>
                    </button>
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div class="col-span-1 md:col-span-2">
                        <label class="text-xs text-gray-500 ml-1">‡∏ä‡∏∑‡πà‡∏≠ Session / ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</label>
                        <input id="sessionName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏∏‡∏Å‡∏ñ‡∏¥‡πà‡∏ô‡πÅ‡∏°‡∏ß‡πÄ‡∏õ‡πâ‡∏≤..."
                            class="w-full p-2.5 rounded-xl input-primary" />
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 ml-1">‡∏ä‡∏∑‡πà‡∏≠ DM</label>
                        <input id="dmName" placeholder="Dungeon Master" class="w-full p-2.5 rounded-xl input-primary" />
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 ml-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô</label>
                        <input id="sessionDate" type="date" class="w-full p-2.5 rounded-xl input-primary" />
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label class="text-xs text-gray-500 ml-1">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (Hrs)</label>
                        <input id="hours" type="number" min="0" step="0.5" placeholder="0"
                            class="w-full p-2.5 rounded-xl input-primary text-center" onchange="calculateAutoGold()" />
                    </div>
                    <div class="md:col-span-10">
                        <label class="text-xs text-gray-500 ml-1">‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <input id="gotItems" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö Potion x2, ‡∏î‡∏≤‡∏ö‡∏¢‡∏≤‡∏ß..."
                            class="w-full p-2.5 rounded-xl input-primary" />
                    </div>
                </div>

                <textarea id="notes" placeholder="Notes (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Session ‡∏ô‡∏µ‡πâ)"
                    class="w-full p-3 mb-4 rounded-xl input-primary h-20 resize-none"></textarea>

                <div
                    class="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gray-900/40 p-4 rounded-xl border border-gray-800">
                    <div class="flex items-center gap-3">
                        <input id="noGold" type="checkbox"
                            class="w-5 h-5 rounded border-gray-600 text-blue-600 focus:ring-blue-500 bg-gray-800"
                            onchange="calculateAutoGold()" />
                        <label class="text-sm text-gray-300 select-none cursor-pointer"
                            for="noGold">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏≠‡∏á</label>
                    </div>

                    <div class="flex gap-6">
                        <div class="flex flex-col items-end">
                            <span
                                class="text-[10px] text-gray-500 uppercase font-bold tracking-wider flex items-center gap-1.5 mb-1">
                                <i class="fa-solid fa-sack-dollar text-yellow-500 drop-shadow-sm"></i> Calculated Gold
                            </span>
                            <span
                                class="font-mono text-yellow-400 font-bold text-lg drop-shadow-[0_0_10px_rgba(250,204,21,0.2)]">
                                <span id="autoGoldAmount">0</span> <span class="text-xs text-yellow-600">GP</span>
                            </span>
                        </div>
                        <div class="flex flex-col items-end">
                            <span
                                class="text-[10px] text-gray-500 uppercase font-bold tracking-wider flex items-center gap-1.5 mb-1">
                                <i class="fa-solid fa-star text-purple-500 drop-shadow-sm"></i> Calculated Favor
                            </span>
                            <span
                                class="font-mono text-purple-400 font-bold text-lg drop-shadow-[0_0_10px_rgba(192,132,252,0.2)]">
                                <span id="autoFavorAmount">0</span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex gap-3">
                    <button id="btnSaveSession" onclick="saveSession()"
                        class="flex-1 sm:flex-none bg-blue-600 hover:bg-blue-500 text-white font-semibold px-6 py-2.5 rounded-xl shadow-lg shadow-blue-600/20 transition-all hover:-translate-y-0.5">
                        <i class="fa-solid fa-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Session
                    </button>
                    <button id="btnCancelSession" onclick="cancelEditSession()"
                        class="hidden bg-gray-700 hover:bg-gray-600 text-white font-medium px-6 py-2.5 rounded-xl transition">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>

            <div class="glass-panel rounded-2xl overflow-hidden shadow-lg">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left text-sm text-gray-300">
                        <thead class="bg-gray-800/80 text-gray-400 uppercase text-xs font-bold tracking-wider">
                            <tr>
                                <th class="py-4 px-6">‡∏ä‡∏∑‡πà‡∏≠ Session</th>
                                <th class="py-4 px-6">DM</th>
                                <th class="py-4 px-6">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="py-4 px-6">Hrs</th>
                                <th class="py-4 px-6">Reward</th>
                                <th class="py-4 px-6 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sessionsBody" class="divide-y divide-gray-800 bg-gray-900/20"></tbody>
                    </table>
                </div>
                <div id="sessionPagination" class="p-4 flex justify-center space-x-2 border-t border-gray-800"></div>
            </div>
        </div>

        <div id="gold" class="tab-content">
            <div class="glass-panel p-6 rounded-2xl shadow-lg mb-8">
                <h2 class="text-lg font-bold mb-5 text-white flex items-center gap-2">
                    <span class="bg-yellow-500/20 text-yellow-400 p-1.5 rounded-lg text-sm"><i
                            class="fa-solid fa-coins"></i></span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≠‡∏á (Gold Transaction)
                </h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <div class="w-full sm:w-1/4">
                        <select id="goldType" class="w-full p-2.5 rounded-xl input-primary">
                            <option value="spend">üí∏ ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏•‡∏ö)</option>
                            <option value="receive">üí∞ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡∏ö‡∏ß‡∏Å)</option>
                        </select>
                    </div>
                    <div class="w-full sm:w-1/4">
                        <input id="goldAmount" type="number" min="0" step="0.1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (GP)"
                            class="w-full p-2.5 rounded-xl input-primary" />
                    </div>
                    <div class="w-full sm:w-2/4">
                        <input id="goldDesc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡∏∑‡πâ‡∏≠ Potion, ‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏¢‡∏∞...)"
                            class="w-full p-2.5 rounded-xl input-primary" />
                    </div>
                </div>
                <button onclick="addGoldEntry()"
                    class="bg-green-600 hover:bg-green-500 text-white font-semibold px-6 py-2.5 rounded-xl shadow-lg shadow-green-600/20 transition-all hover:-translate-y-0.5">
                    <i class="fa-solid fa-check mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
            </div>

            <div class="glass-panel rounded-2xl overflow-hidden shadow-lg">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left text-sm text-gray-300">
                        <thead class="bg-gray-800/80 text-gray-400 uppercase text-xs font-bold tracking-wider">
                            <tr>
                                <th class="py-4 px-6">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th class="py-4 px-6">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (GP)</th>
                                <th class="py-4 px-6">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="py-4 px-6 w-20"></th>
                            </tr>
                        </thead>
                        <tbody id="goldBody" class="divide-y divide-gray-800 bg-gray-900/20"></tbody>
                    </table>
                </div>
                <div id="goldPagination" class="p-4 flex justify-center space-x-2 border-t border-gray-800"></div>
            </div>
        </div>

        <div id="favor" class="tab-content">
            <div class="glass-panel p-6 rounded-2xl shadow-lg mb-8">
                <h2 class="text-lg font-bold mb-5 text-white flex items-center gap-2">
                    <span class="bg-purple-500/20 text-purple-400 p-1.5 rounded-lg text-sm"><i
                            class="fa-solid fa-star"></i></span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Favor
                </h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <div class="w-full sm:w-1/4">
                        <select id="favorType" class="w-full p-2.5 rounded-xl input-primary">
                            <option value="spend">‚ú® ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ (‡∏•‡∏ö)</option>
                            <option value="receive">üåü ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡∏ö‡∏ß‡∏Å)</option>
                        </select>
                    </div>
                    <div class="w-full sm:w-1/4">
                        <input id="favorAmount" type="number" min="0" step="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Favor"
                            class="w-full p-2.5 rounded-xl input-primary" />
                    </div>
                    <div class="w-full sm:w-2/4">
                        <input id="favorDesc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."
                            class="w-full p-2.5 rounded-xl input-primary" />
                    </div>
                </div>
                <button onclick="addFavorEntry()"
                    class="bg-purple-600 hover:bg-purple-500 text-white font-semibold px-6 py-2.5 rounded-xl shadow-lg shadow-purple-600/20 transition-all hover:-translate-y-0.5">
                    <i class="fa-solid fa-check mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
            </div>

            <div class="glass-panel rounded-2xl overflow-hidden shadow-lg">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left text-sm text-gray-300">
                        <thead class="bg-gray-800/80 text-gray-400 uppercase text-xs font-bold tracking-wider">
                            <tr>
                                <th class="py-4 px-6">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th class="py-4 px-6">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                <th class="py-4 px-6">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="py-4 px-6 w-20"></th>
                            </tr>
                        </thead>
                        <tbody id="favorBody" class="divide-y divide-gray-800 bg-gray-900/20"></tbody>
                    </table>
                </div>
                <div id="favorPagination" class="p-4 flex justify-center space-x-2 border-t border-gray-800"></div>
            </div>
        </div>

        <div id="dm" class="tab-content">
            <div class="glass-panel p-6 rounded-2xl shadow-lg mb-8" id="dmFormCard">
                <h2 class="text-lg font-bold mb-5 text-white flex items-center gap-2">
                    <span class="bg-red-500/20 text-red-400 p-1.5 rounded-lg text-sm"><i
                            class="fa-solid fa-dungeon"></i></span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô DM
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="md:col-span-1">
                        <label class="text-xs text-gray-500 ml-1">‡∏ä‡∏∑‡πà‡∏≠ Session</label>
                        <input id="dmSessionName" placeholder="Session Name"
                            class="w-full p-2.5 rounded-xl input-primary" />
                    </div>
                    <div class="md:col-span-1">
                        <label class="text-xs text-gray-500 ml-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input id="dmSessionDate" type="date" class="w-full p-2.5 rounded-xl input-primary" />
                    </div>
                    <div class="md:col-span-1">
                        <label class="text-xs text-gray-500 ml-1">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (Hrs)</label>
                        <input id="dmHours" type="number" min="0" step="0.5" placeholder="0"
                            class="w-full p-2.5 rounded-xl input-primary" onchange="calculateDmRewards()" />
                    </div>
                </div>

                <div class="flex flex-wrap gap-4 mb-6 bg-gray-900/30 p-3 rounded-xl border border-gray-800">
                    <div class="flex items-center gap-2">
                        <input id="soloQuest" type="checkbox"
                            class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-red-500 focus:ring-red-500"
                            onchange="calculateDmRewards()" />
                        <label for="soloQuest" class="text-sm text-gray-300 cursor-pointer">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß (Solo)</label>
                    </div>
                    <div class="h-6 w-[1px] bg-gray-700"></div>
                    <div class="flex items-center gap-2">
                        <input id="doubleReward" type="checkbox"
                            class="w-4 h-4 rounded border-gray-600 bg-gray-800 text-red-500 focus:ring-red-500"
                            onchange="calculateDmRewards()" />
                        <label for="doubleReward" class="text-sm text-gray-300 cursor-pointer">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• x2</label>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 mb-6 text-center">
                    <div
                        class="bg-gray-800/50 p-3 rounded-xl border border-gray-700 hover:border-yellow-500/50 transition-colors group">
                        <p
                            class="text-[10px] text-gray-500 uppercase font-bold tracking-wider flex items-center justify-center gap-1.5 mb-1 group-hover:text-gray-400 transition-colors">
                            <i
                                class="fa-solid fa-sack-dollar text-yellow-500 group-hover:scale-110 transition-transform"></i>
                            Calculated Gold
                        </p>
                        <p class="text-yellow-400 font-bold text-lg drop-shadow-[0_0_8px_rgba(250,204,21,0.3)]">
                            <span id="dmAutoGold">0</span> <span class="text-[10px] ml-0.5 text-yellow-600">GP</span>
                        </p>
                    </div>

                    <div
                        class="bg-gray-800/50 p-3 rounded-xl border border-gray-700 hover:border-purple-500/50 transition-colors group">
                        <p
                            class="text-[10px] text-gray-500 uppercase font-bold tracking-wider flex items-center justify-center gap-1.5 mb-1 group-hover:text-gray-400 transition-colors">
                            <i class="fa-solid fa-star text-purple-500 group-hover:scale-110 transition-transform"></i>
                            Calculated Favor
                        </p>
                        <p class="text-purple-400 font-bold text-lg drop-shadow-[0_0_8px_rgba(192,132,252,0.3)]">
                            <span id="dmAutoFavor">0</span>
                        </p>
                    </div>

                    <div
                        class="bg-gray-800/50 p-3 rounded-xl border border-gray-700 hover:border-green-500/50 transition-colors group">
                        <p
                            class="text-[10px] text-gray-500 uppercase font-bold tracking-wider flex items-center justify-center gap-1.5 mb-1 group-hover:text-gray-400 transition-colors">
                            <i
                                class="fa-solid fa-stopwatch text-green-500 group-hover:scale-110 transition-transform"></i>
                            Calculated Hours
                        </p>
                        <p class="text-green-400 font-bold text-lg drop-shadow-[0_0_8px_rgba(74,222,128,0.3)]">
                            <span id="dmAutoHours">0</span>
                        </p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button id="btnSaveDmLog" onclick="saveDmLog()"
                        class="flex-1 sm:flex-none bg-red-600 hover:bg-red-500 text-white font-semibold px-6 py-2.5 rounded-xl shadow-lg shadow-red-600/20 transition-all hover:-translate-y-0.5">
                        <i class="fa-solid fa-save mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å DM Log
                    </button>
                    <button id="btnCancelDmLog" onclick="cancelEditDmLog()"
                        class="hidden bg-gray-700 hover:bg-gray-600 text-white font-medium px-6 py-2.5 rounded-xl transition">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>

            <div class="glass-panel rounded-2xl overflow-hidden shadow-lg">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left text-sm text-gray-300">
                        <thead class="bg-gray-800/80 text-gray-400 uppercase text-xs font-bold tracking-wider">
                            <tr>
                                <th class="py-4 px-6">Session</th>
                                <th class="py-4 px-6">Date</th>
                                <th class="py-4 px-6">Hrs</th>
                                <th class="py-4 px-6">Gold</th>
                                <th class="py-4 px-6">Favor</th>
                                <th class="py-4 px-6 text-center">Mod</th>
                                <th class="py-4 px-6 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dmBody" class="divide-y divide-gray-800 bg-gray-900/20"></tbody>
                    </table>
                </div>
                <div id="dmPagination" class="p-4 flex justify-center space-x-2 border-t border-gray-800"></div>
            </div>
        </div>

        <div id="char-notes" class="tab-content">
            <div class="glass-panel p-6 rounded-2xl shadow-lg mb-6 relative border-t-4 border-t-blue-500/50">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-200 flex items-center gap-2">
                        <i class="fa-solid fa-book text-blue-400"></i> ‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Auto-Save)
                    </h2>
                    <span id="noteStatus"
                        class="text-xs font-medium transition-opacity duration-300 opacity-0 px-3 py-1 rounded-full bg-gray-800 border border-gray-700 text-gray-400">
                        Ready
                    </span>
                </div>

                <textarea id="charNotesInput"
                    class="w-full h-[500px] p-5 rounded-xl bg-[#1e1e1e] border border-gray-700 text-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 leading-relaxed font-mono text-sm shadow-inner resize-none"
                    placeholder="// ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏¥‡∏™‡∏£‡∏∞... ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå"
                    oninput="handleNoteInput()"></textarea>

                <div class="flex justify-between mt-3 text-xs text-gray-500">
                    <span>Supports Markdown-like plain text</span>
                    <span class="flex items-center"><i class="fa-solid fa-cloud mr-1"></i> Synced with Database</span>
                </div>
            </div>
        </div>

        <footer class="mt-16 text-center text-xs text-gray-600 border-t border-gray-800 pt-8">
            <p>&copy; üè∞ The Spire Tracking | Created by aKittyCatüêà. All rights reserved.</p>
        </footer>
    </div>

    <script src="/js/utils.js"></script>
    <script>
        let currentUser = null;
        let isAdmin = false;
        let currentCharId = new URLSearchParams(window.location.search).get('charId');
        let currentCharData = null;
        let noteTimeout = null;

        const ITEMS_PER_PAGE = 10;
        let pageState = { session: 1, gold: 1, favor: 1, dm: 1 };
        let sessionsData = [], goldData = [], favorData = [], dmData = [];
        let editingSessionId = null;
        let editingDmLogId = null;

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            currentUser = session.user;
            document.getElementById('userEmail').textContent = currentUser.email;

            const { data: adminStatus } = await supabase.rpc('is_admin');
            isAdmin = adminStatus;

            if (!currentCharId) { window.location.href = 'characters.html'; return; }
            if (isAdmin) document.getElementById('btnBulkImport').classList.remove('hidden');
            refreshAllData();
        }
        init();

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        // --- Load Data ---
        async function refreshAllData() {
            // Fetch raw char data for notes/pets/alignment which might not be in the view
            const { data: charInfo } = await supabase.from('characters').select('user_id, pets, alignment, notes').eq('id', currentCharId).single();

            if (!charInfo) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£'); window.location.href = 'characters.html'; return; }
            if (charInfo.user_id !== currentUser.id && !isAdmin) { alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå'); window.location.href = 'characters.html'; return; }

            // Fetch Stats
            const { data: stats } = await supabase.rpc('get_character_stats', { target_user_id: charInfo.user_id });
            const c = stats?.find(x => x.id === currentCharId);
            if (!c) return;

            currentCharData = { ...c, pets: charInfo.pets, notes: charInfo.notes, alignment: charInfo.alignment };

            renderHeader();

            const noteInput = document.getElementById('charNotesInput');
            if (noteInput) {
                noteInput.value = currentCharData.notes || '';
            }

            loadLists();
        }

        function getAlignmentStyle(alignment) {
            const al = (alignment || '').toLowerCase();
            // Good alignments - Green
            if (al.includes('good')) {
                return 'bg-emerald-500/20 border-emerald-500/50 text-emerald-300';
            }
            // Evil alignments - Red
            if (al.includes('evil')) {
                return 'bg-red-500/20 border-red-500/50 text-red-300';
            }
            // Lawful (without good/evil) - Blue
            if (al.includes('lawful')) {
                return 'bg-blue-500/20 border-blue-500/50 text-blue-300';
            }
            // Chaotic (without good/evil) - Purple
            if (al.includes('chaotic')) {
                return 'bg-purple-500/20 border-purple-500/50 text-purple-300';
            }
            // Neutral - Gray
            return 'bg-gray-700/50 border-gray-600 text-gray-300';
        }

        function getTierStyle(tier) {
            switch (tier) {
                case 'Tier 1': return 'bg-slate-600/80 text-slate-200 border-slate-500';
                case 'Tier 2': return 'bg-emerald-600/80 text-emerald-100 border-emerald-500';
                case 'Tier 3': return 'bg-blue-600/80 text-blue-100 border-blue-500';
                case 'Tier 4': return 'bg-purple-600/80 text-purple-100 border-purple-500';
                case 'Tier 5': return 'bg-amber-500/80 text-amber-100 border-amber-400';
                default: return 'bg-gray-800/80 text-gray-300 border-gray-600';
            }
        }

        function renderHeader() {
            const c = currentCharData;
            document.getElementById('charName').textContent = c.name;
            document.getElementById('charPets').textContent = c.pets || 'None';

            // Alignment Style with color coding
            const alignEl = document.getElementById('charAlignment');
            const alignVal = c.alignment || '-';
            alignEl.textContent = alignVal;
            const alignStyle = getAlignmentStyle(alignVal);
            alignEl.className = `px-3 py-1.5 rounded-lg border text-xs font-medium tracking-wide transition-colors duration-200 ${alignStyle}`;

            const totalHours = (Number(c.total_sessions_hours) || 0) + (Number(c.total_dm_hours) || 0);
            const { level: currentLevel, hoursToNextLevel } = calculateCurrentLevel(c.level, totalHours);
            const displayTotalHours = totalHours;

            document.getElementById('charCurrentLevel').textContent = currentLevel;
            document.getElementById('charTotalHours').textContent = displayTotalHours.toFixed(2);
            document.getElementById('charTotalHoursPlus').textContent = (displayTotalHours + 10.5).toFixed(2);
            document.getElementById('charHoursToLevelUp').textContent = currentLevel >= 30 ? 'Max' : `${hoursToNextLevel.toFixed(2)}`;

            // Tier Style with color coding
            const tierText = getTierFromLevel(currentLevel);
            const tierEl = document.getElementById('charTier');
            tierEl.textContent = tierText;
            const tierStyle = getTierStyle(tierText);
            tierEl.className = `px-3 py-1 border rounded-lg text-[10px] font-bold uppercase tracking-wider shadow-sm backdrop-blur-sm ${tierStyle}`;

            document.getElementById('charClass').textContent = c.class || 'Unknown';
            document.getElementById('charRace').textContent = c.race || 'Unknown';
            document.getElementById('charGoldStart').textContent = c.gold_start;

            document.getElementById('charTotalGold').textContent = Number(c.total_gold).toLocaleString();
            document.getElementById('charTotalFavor').textContent = Number(c.total_favor).toLocaleString();

            const sheetBtn = document.getElementById('sheetLink');
            if (c.sheet_link) {
                sheetBtn.href = c.sheet_link;
                sheetBtn.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                sheetBtn.href = '#';
                sheetBtn.classList.add('opacity-50', 'pointer-events-none');
            }
        }

        function handleNoteInput() {
            const status = document.getElementById('noteStatus');
            status.innerHTML = '<i class="fa-solid fa-pen-nib animate-bounce"></i> Typing...';
            status.className = 'text-xs font-medium transition-opacity duration-300 opacity-100 bg-yellow-900/50 text-yellow-300 px-3 py-1 rounded-full border border-yellow-700';

            clearTimeout(noteTimeout);
            noteTimeout = setTimeout(saveNotes, 1000);
        }

        async function saveNotes() {
            const notes = document.getElementById('charNotesInput').value;
            const status = document.getElementById('noteStatus');

            status.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
            status.className = 'text-xs font-medium transition-opacity duration-300 opacity-100 bg-blue-900/50 text-blue-300 px-3 py-1 rounded-full border border-blue-700';

            const { error } = await supabase
                .from('characters')
                .update({ notes: notes })
                .eq('id', currentCharId);

            if (error) {
                console.error('Save failed:', error);
                status.innerHTML = 'Error';
                status.className = 'text-xs font-medium bg-red-900/50 text-red-300 px-3 py-1 rounded-full border border-red-700 opacity-100';
            } else {
                status.innerHTML = '<i class="fa-solid fa-check"></i> Saved';
                status.className = 'text-xs font-medium bg-green-900/50 text-green-300 px-3 py-1 rounded-full border border-green-700 opacity-100';
                setTimeout(() => { status.style.opacity = '0'; }, 2000);
            }
        }

        async function loadLists() {
            loadSessions(pageState.session);
            loadGold(pageState.gold);
            loadFavor(pageState.favor);
            loadDmLogs(pageState.dm);
        }

        // --- Pagination Functions ---
        async function loadSessions(page) {
            pageState.session = page;
            const from = (page - 1) * ITEMS_PER_PAGE;
            const to = from + ITEMS_PER_PAGE - 1;
            const { data, count } = await supabase.from('sessions').select('*', { count: 'exact' }).eq('character_id', currentCharId).order('created_at', { ascending: false }).range(from, to);
            sessionsData = data || [];
            renderSessions(count || 0);
        }
        async function loadGold(page) {
            pageState.gold = page;
            const from = (page - 1) * ITEMS_PER_PAGE;
            const to = from + ITEMS_PER_PAGE - 1;
            const { data, count } = await supabase.from('gold_logs').select('*', { count: 'exact' }).eq('character_id', currentCharId).order('created_at', { ascending: false }).range(from, to);
            goldData = data || [];
            renderGold(count || 0);
        }
        async function loadFavor(page) {
            pageState.favor = page;
            const from = (page - 1) * ITEMS_PER_PAGE;
            const to = from + ITEMS_PER_PAGE - 1;
            const { data, count } = await supabase.from('favor_logs').select('*', { count: 'exact' }).eq('character_id', currentCharId).order('created_at', { ascending: false }).range(from, to);
            favorData = data || [];
            renderFavor(count || 0);
        }
        async function loadDmLogs(page) {
            pageState.dm = page;
            const from = (page - 1) * ITEMS_PER_PAGE;
            const to = from + ITEMS_PER_PAGE - 1;
            const { data, count } = await supabase.from('dm_logs').select('*', { count: 'exact' }).eq('character_id', currentCharId).order('created_at', { ascending: false }).range(from, to);
            dmData = data || [];
            renderDmLogs(count || 0);
        }

        // --- Logic Helpers ---
        function getGoldMultiplier(level) {
            if (level >= 23) return 1.5; if (level >= 17) return 1.4; if (level >= 11) return 1.3; if (level >= 5) return 1.2; if (level >= 3) return 1.1; return 1.0;
        }

        function calculateCurrentLevel(startLevel, totalHours) {
            const LEVEL_HOURS = [0, 0, 3.5, 10.5, 21, 35, 52.5, 73.5, 98, 126, 157.5, 192.5, 231, 273, 318.5, 367.5, 420, 476, 535.5, 598.5, 665, 735, 808.5, 885.5, 966, 1050, 1137.5, 1228.5, 1323, 1421, 1522.5, 0];
            let currentLevel = startLevel;
            const total = (LEVEL_HOURS[startLevel] || 0) + totalHours;
            for (let i = startLevel + 1; i <= 30; i++) { if (total >= LEVEL_HOURS[i]) currentLevel = i; else break; }
            const next = currentLevel >= 30 ? 0 : LEVEL_HOURS[currentLevel + 1] - total;
            return { level: currentLevel, hoursToNextLevel: Math.max(0, next) };
        }

        function getTierFromLevel(level) {
            if (level >= 23) return "Tier 5"; if (level >= 17) return "Tier 4"; if (level >= 11) return "Tier 3"; if (level >= 5) return "Tier 2"; return "Tier 1";
        }

        // --- Session CRUD ---
        async function saveSession() {
            const name = document.getElementById('sessionName').value.trim();
            if (!name) return alert('‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ Session');

            const btn = document.getElementById('btnSaveSession');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;

            const hours = parseFloat(document.getElementById('hours').value) || 0;
            const noGold = document.getElementById('noGold').checked;
            const autoGold = noGold ? 0 : parseFloat(document.getElementById('autoGoldAmount').textContent.replace(/,/g, ''));
            const autoFavor = Math.floor(hours * 2);

            const payload = {
                name, dm: document.getElementById('dmName').value,
                date: document.getElementById('sessionDate').value || null,
                hours, notes: document.getElementById('notes').value,
                no_gold: noGold, auto_gold: autoGold, auto_favor: autoFavor,
                got_items: document.getElementById('gotItems').value
            };

            let error;
            if (editingSessionId) {
                const res = await supabase.from('sessions').update(payload).eq('id', editingSessionId);
                error = res.error;
            } else {
                payload.character_id = currentCharId;
                payload.user_id = currentUser.id;
                const res = await supabase.from('sessions').insert(payload);
                error = res.error;
            }

            if (error) {
                alert('Error: ' + error.message);
                btn.innerHTML = originalText;
            } else {
                refreshAllData();
                cancelEditSession();
            }

            btn.disabled = false;
        }

        function editSession(id) {
            const item = sessionsData.find(s => s.id === id);
            if (!item) return;
            document.getElementById('sessionName').value = item.name;
            document.getElementById('dmName').value = item.dm || '';
            document.getElementById('sessionDate').value = item.date || '';
            document.getElementById('hours').value = item.hours;
            document.getElementById('notes').value = item.notes || '';
            document.getElementById('noGold').checked = item.no_gold;
            document.getElementById('gotItems').value = item.got_items || '';
            document.getElementById('autoGoldAmount').textContent = Number(item.auto_gold).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 });
            document.getElementById('autoFavorAmount').textContent = item.auto_favor;
            editingSessionId = id;

            const btn = document.getElementById('btnSaveSession');
            btn.innerHTML = '<i class="fa-solid fa-pen"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Session';
            btn.classList.replace('bg-blue-600', 'bg-yellow-600');
            btn.classList.replace('hover:bg-blue-500', 'hover:bg-yellow-500');
            document.getElementById('btnCancelSession').classList.remove('hidden');
            document.getElementById('sessionFormCard').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEditSession() {
            editingSessionId = null;
            document.getElementById('sessionName').value = '';
            document.getElementById('dmName').value = '';
            document.getElementById('sessionDate').value = '';
            document.getElementById('hours').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('noGold').checked = false;
            document.getElementById('gotItems').value = '';
            document.getElementById('autoGoldAmount').textContent = '0';
            document.getElementById('autoFavorAmount').textContent = '0';

            const btn = document.getElementById('btnSaveSession');
            btn.innerHTML = '<i class="fa-solid fa-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Session';
            btn.classList.replace('bg-yellow-600', 'bg-blue-600');
            btn.classList.replace('hover:bg-yellow-500', 'hover:bg-blue-500');

            document.getElementById('btnCancelSession').classList.add('hidden');
        }

        function calculateAutoGold() {
            const hours = parseFloat(document.getElementById('hours').value) || 0;
            const isNoGold = document.getElementById('noGold').checked;

            // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Favor ‡πÄ‡∏™‡∏°‡∏≠ (Hrs x 2)
            const favor = Math.floor(hours * 2);
            document.getElementById('autoFavorAmount').textContent = favor;

            if (isNoGold) {
                document.getElementById('autoGoldAmount').textContent = '0';
            } else {
                const c = currentCharData || {};
                const currentTotalHours = (Number(c.total_sessions_hours) || 0) + (Number(c.total_dm_hours) || 0);

                const projectedTotalHours = currentTotalHours + hours;

                const { level: projectedLevel } = calculateCurrentLevel(c.level, projectedTotalHours);

                const multiplier = getGoldMultiplier(projectedLevel);

                const gold = Math.round(hours * 100 * multiplier);

                document.getElementById('autoGoldAmount').textContent = gold.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 });
            }
        }

        // --- Other CRUD ---
        async function addGoldEntry() {
            const amount = parseFloat(document.getElementById('goldAmount').value);
            if (!amount || amount <= 0) return alert('‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0)');
            const type = document.getElementById('goldType').value;
            let finalAmount = amount;

            if (type === 'spend') finalAmount = -Math.abs(amount);
            else finalAmount = Math.abs(amount);

            const { error } = await supabase.from('gold_logs').insert({
                character_id: currentCharId,
                user_id: currentUser.id,
                description: document.getElementById('goldDesc').value,
                amount: finalAmount
            });

            if (error) alert(error.message);
            else {
                document.getElementById('goldDesc').value = '';
                document.getElementById('goldAmount').value = '';
                refreshAllData();
            }
        }

        async function addFavorEntry() {
            const amount = parseFloat(document.getElementById('favorAmount').value);
            const type = document.getElementById('favorType').value;
            let finalAmount = amount;

            if (type === 'spend') finalAmount = -Math.abs(amount);
            else finalAmount = Math.abs(amount);

            const { error } = await supabase.from('favor_logs').insert({
                character_id: currentCharId, user_id: currentUser.id,
                description: document.getElementById('favorDesc').value, amount: finalAmount
            });
            if (error) alert(error.message);
            else {
                document.getElementById('favorDesc').value = '';
                document.getElementById('favorAmount').value = '';
                refreshAllData();
            }
        }

        async function saveDmLog() {
            const btn = document.getElementById('btnSaveDmLog');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;

            const hours = parseFloat(document.getElementById('dmHours').value) || 0;
            const solo = document.getElementById('soloQuest').checked;
            const double = document.getElementById('doubleReward').checked;

            const c = currentCharData || {};
            const currentTotalHours = (Number(c.total_sessions_hours) || 0) + (Number(c.total_dm_hours) || 0);
            let finalHours = hours * 1.5; if (double) finalHours *= 2;
            const projectedTotalHours = currentTotalHours + finalHours;
            const { level: currentLevel } = calculateCurrentLevel(c.level, projectedTotalHours);
            const mult = getGoldMultiplier(currentLevel);

            let autoGold = 0, autoFavor = 0;
            if (!solo) {
                let rawGold = hours * 100 * mult * 1.5;
                autoGold = Math.round(rawGold);
                autoFavor = Math.floor(hours * 4);
                if (double) { autoGold *= 2; autoFavor *= 2; }
                autoGold = Math.floor(autoGold);
            }

            const payload = {
                session_name: document.getElementById('dmSessionName').value,
                date: document.getElementById('dmSessionDate').value || null,
                hours: finalHours, solo_quest: solo, double_reward: double,
                auto_gold: autoGold, auto_favor: autoFavor
            };

            let error;
            if (editingDmLogId) {
                const res = await supabase.from('dm_logs').update(payload).eq('id', editingDmLogId);
                error = res.error;
            } else {
                payload.character_id = currentCharId;
                payload.user_id = currentUser.id;
                const res = await supabase.from('dm_logs').insert(payload);
                error = res.error;
            }

            if (error) {
                alert('Error: ' + error.message);
                btn.innerHTML = originalText;
            } else {
                refreshAllData();
                cancelEditDmLog();
            }

            btn.disabled = false;
        }

        function editDmLog(id) {
            const item = dmData.find(d => d.id === id);
            if (!item) return;
            let baseHours = item.hours;
            if (item.double_reward) baseHours /= 2;
            baseHours /= 1.5;

            document.getElementById('dmSessionName').value = item.session_name;
            document.getElementById('dmSessionDate').value = item.date || '';
            document.getElementById('dmHours').value = parseFloat(baseHours.toFixed(2));
            document.getElementById('soloQuest').checked = item.solo_quest;
            document.getElementById('doubleReward').checked = item.double_reward;
            document.getElementById('dmAutoGold').textContent = Number(item.auto_gold).toLocaleString();
            document.getElementById('dmAutoFavor').textContent = item.auto_favor;
            document.getElementById('dmAutoHours').textContent = item.hours;
            editingDmLogId = id;

            const btn = document.getElementById('btnSaveDmLog');
            btn.innerHTML = '<i class="fa-solid fa-pen"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï DM Session';
            btn.classList.replace('bg-red-600', 'bg-yellow-600');
            btn.classList.replace('hover:bg-red-500', 'hover:bg-yellow-500');
            document.getElementById('btnCancelDmLog').classList.remove('hidden');
            document.getElementById('dmFormCard').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEditDmLog() {
            editingDmLogId = null;
            document.getElementById('dmSessionName').value = '';
            document.getElementById('dmSessionDate').value = '';
            document.getElementById('dmHours').value = '';
            document.getElementById('soloQuest').checked = false;
            document.getElementById('doubleReward').checked = false;
            document.getElementById('dmAutoGold').textContent = '0';
            document.getElementById('dmAutoFavor').textContent = '0';
            document.getElementById('dmAutoHours').textContent = '0';

            const btn = document.getElementById('btnSaveDmLog');
            btn.innerHTML = '<i class="fa-solid fa-save mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å DM Log';
            btn.classList.replace('bg-yellow-600', 'bg-red-600');
            btn.classList.replace('hover:bg-yellow-500', 'hover:bg-red-500');
            document.getElementById('btnCancelDmLog').classList.add('hidden');
        }

        function calculateDmRewards() {
            const hours = parseFloat(document.getElementById('dmHours').value) || 0;
            const solo = document.getElementById('soloQuest').checked;
            const double = document.getElementById('doubleReward').checked;
            const c = currentCharData || {};
            const currentTotalHours = (Number(c.total_sessions_hours) || 0) + (Number(c.total_dm_hours) || 0);
            let finalHours = hours * 1.5; if (double) finalHours *= 2;
            const projectedTotalHours = currentTotalHours + finalHours;
            const { level } = calculateCurrentLevel(c.level, projectedTotalHours);
            const mult = getGoldMultiplier(level);
            let gold = 0, favor = 0;
            if (!solo) {
                let rawGold = hours * 100 * mult * 1.5;
                gold = Math.round(rawGold);
                favor = Math.floor(hours * 4);
                if (double) { gold *= 2; favor *= 2; }
                gold = Math.floor(gold);
            }
            document.getElementById('dmAutoGold').textContent = gold.toLocaleString();
            document.getElementById('dmAutoFavor').textContent = favor;
            document.getElementById('dmAutoHours').textContent = finalHours;
        }

        function editCharacter() {
            const c = currentCharData;
            document.getElementById('editCharName').value = c.name || '';
            document.getElementById('editCharClass').value = c.class || '';
            document.getElementById('editCharRace').value = c.race || '';
            document.getElementById('editCharSheetLink').value = c.sheet_link || '';
            document.getElementById('editCharAlignment').value = c.alignment || '';
            document.getElementById('editCharPets').value = c.pets || '';

            const adminFields = document.getElementById('editCharAdminFields');
            if (isAdmin) {
                adminFields.classList.remove('hidden');
                document.getElementById('editCharLevel').value = c.level || 1;
                document.getElementById('editCharGoldStart').value = c.gold_start || 0;
            } else {
                adminFields.classList.add('hidden');
            }

            document.getElementById('editCharModal').classList.remove('hidden');
            document.getElementById('editCharModal').classList.add('flex');
        }

        function closeEditCharacterModal() {
            document.getElementById('editCharModal').classList.add('hidden');
            document.getElementById('editCharModal').classList.remove('flex');
            const btn = document.getElementById('btnSaveEditChar');
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-save mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        }

        async function saveEditCharacter() {
            const btn = document.getElementById('btnSaveEditChar');
            if (btn.disabled) return;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            const payload = {
                name: document.getElementById('editCharName').value.trim(),
                class: document.getElementById('editCharClass').value.trim(),
                race: document.getElementById('editCharRace').value.trim(),
                sheet_link: document.getElementById('editCharSheetLink').value.trim(),
                alignment: document.getElementById('editCharAlignment').value.trim(),
                pets: document.getElementById('editCharPets').value.trim()
            };

            if (!payload.name) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£');
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-save mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                return;
            }

            if (isAdmin) {
                payload.level = parseInt(document.getElementById('editCharLevel').value) || currentCharData.level;
                payload.gold_start = parseInt(document.getElementById('editCharGoldStart').value) || currentCharData.gold_start;
            }

            const { error } = await supabase.from('characters').update(payload).eq('id', currentCharId);

            if (error) {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-save mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            } else {
                closeEditCharacterModal();
                refreshAllData();
            }
        }

        async function deleteSession(id) { if (!confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö Session ‡∏ô‡∏µ‡πâ?')) return; const { error } = await supabase.from('sessions').delete().eq('id', id); if (error) alert(error.message); else refreshAllData(); }
        async function deleteGold(id) { if (!confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return; const { error } = await supabase.from('gold_logs').delete().eq('id', id); if (error) alert(error.message); else refreshAllData(); }
        async function deleteFavor(id) { if (!confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return; const { error } = await supabase.from('favor_logs').delete().eq('id', id); if (error) alert(error.message); else refreshAllData(); }
        async function deleteDmLog(id) { if (!confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return; const { error } = await supabase.from('dm_logs').delete().eq('id', id); if (error) alert(error.message); else refreshAllData(); }

        // --- Render Tables ---
        function renderPaginationUI(elementId, totalItems, currentPage, loadFunction) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            if (totalPages <= 1) return;

            // Prev
            const prevBtn = document.createElement('button');
            prevBtn.innerHTML = '<i class="fa-solid fa-chevron-left"></i>';
            prevBtn.className = `w-8 h-8 rounded-lg text-xs font-medium transition ${currentPage === 1 ? 'text-gray-600 cursor-not-allowed' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}`;
            prevBtn.onclick = () => { if (currentPage > 1) loadFunction(currentPage - 1); };
            container.appendChild(prevBtn);

            for (let i = 1; i <= totalPages; i++) {
                if (totalPages > 5 && Math.abs(currentPage - i) > 1 && i !== 1 && i !== totalPages) continue; // Compact logic
                const btn = document.createElement('button');
                btn.innerText = i;
                btn.className = `w-8 h-8 rounded-lg text-xs font-medium transition ${i === currentPage ? 'bg-indigo-600 text-white shadow' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}`;
                btn.onclick = () => loadFunction(i);
                container.appendChild(btn);
            }

            // Next
            const nextBtn = document.createElement('button');
            nextBtn.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';
            nextBtn.className = `w-8 h-8 rounded-lg text-xs font-medium transition ${currentPage === totalPages ? 'text-gray-600 cursor-not-allowed' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}`;
            nextBtn.onclick = () => { if (currentPage < totalPages) loadFunction(currentPage + 1); };
            container.appendChild(nextBtn);
        }

        function renderSessions(count) {
            const tbody = document.getElementById('sessionsBody'); tbody.innerHTML = '';
            if (sessionsData.length === 0) { tbody.innerHTML = '<tr><td colspan="10" class="py-8 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Session</td></tr>'; return; }

            sessionsData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-800/50 transition-colors border-b border-gray-800 last:border-0";
                tr.innerHTML = `
            <td class="py-4 px-6 text-white font-medium">
                ${item.name}
                <div class="text-xs text-gray-500 truncate max-w-[200px] mt-0.5">${item.got_items || '-'}</div>
                <div class="text-xs text-gray-500 truncate max-w-[200px] mt-0.5">${item.notes || '-'}</div>           
            </td>
            <td class="py-4 px-6 text-gray-400 text-xs">${item.dm || '-'}</td>
            <td class="py-4 px-6 text-gray-400 text-xs whitespace-nowrap">${item.date ? new Date(item.date).toLocaleDateString('th-TH') : '-'}</td>
            <td class="py-4 px-6 text-gray-300 font-mono">${item.hours}</td>
            <td class="py-4 px-6">
                ${item.no_gold
                        ? '<span class="text-xs text-gray-500">No Reward</span>'
                        : `<div class="flex flex-col text-xs">
                         <span class="text-yellow-400">${item.auto_gold} GP</span>
                         <span class="text-purple-400">${item.auto_favor || 0} Favor</span>
                       </div>`
                    }
            </td>
            <td class="py-4 px-6 text-center">
                <div class="flex justify-center gap-2">
                    <button onclick="editSession('${item.id}')" class="text-gray-500 hover:text-yellow-400 transition p-1"><i class="fa-solid fa-pen"></i></button>
                    <button onclick="deleteSession('${item.id}')" class="text-gray-500 hover:text-red-400 transition p-1"><i class="fa-solid fa-trash"></i></button>
                </div>
            </td>
        `;
                tbody.appendChild(tr);
            });
            renderPaginationUI('sessionPagination', count, pageState.session, loadSessions);
        }

        function renderGold(count) {
            const tbody = document.getElementById('goldBody'); tbody.innerHTML = '';
            if (goldData.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="py-8 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ó‡∏≠‡∏á</td></tr>'; return; }

            goldData.forEach(item => {
                const isPositive = item.amount >= 0;
                const colorClass = isPositive ? 'text-green-400' : 'text-red-400';
                const sign = isPositive ? '+' : '';

                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-800/50 transition-colors border-b border-gray-800 last:border-0";
                tr.innerHTML = `
            <td class="py-4 px-6 text-white">
                ${item.description}
            </td>
            <td class="py-4 px-6 font-mono font-medium ${colorClass}">
                ${sign}${Number(item.amount).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 })}
            </td>
            <td class="py-4 px-6 text-gray-500 text-xs">
                ${item.created_at ? new Date(item.created_at).toLocaleDateString('th-TH') : '-'}
            </td>
            <td class="py-4 px-6 text-right">
                <button onclick="deleteGold('${item.id}')" class="text-gray-600 hover:text-red-400 transition"><i class="fa-solid fa-trash"></i></button>
            </td>`;
                tbody.appendChild(tr);
            });
            renderPaginationUI('goldPagination', count, pageState.gold, loadGold);
        }

        function renderFavor(count) {
            const tbody = document.getElementById('favorBody'); tbody.innerHTML = '';
            if (favorData.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="py-8 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Favor</td></tr>'; return; }

            favorData.forEach(item => {
                const isPositive = item.amount >= 0;
                const colorClass = isPositive ? 'text-green-400' : 'text-red-400';
                const sign = isPositive ? '+' : '';

                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-800/50 transition-colors border-b border-gray-800 last:border-0";
                tr.innerHTML = `
            <td class="py-4 px-6 text-white">
                ${item.description}
            </td>
            <td class="py-4 px-6 font-mono font-medium ${colorClass}">
                ${sign}${item.amount}
            </td>
            <td class="py-4 px-6 text-gray-500 text-xs">
                ${item.created_at ? new Date(item.created_at).toLocaleDateString('th-TH') : '-'}
            </td>
            <td class="py-4 px-6 text-right">
                <button onclick="deleteFavor('${item.id}')" class="text-gray-600 hover:text-red-400 transition"><i class="fa-solid fa-trash"></i></button>
            </td>`;
                tbody.appendChild(tr);
            });
            renderPaginationUI('favorPagination', count, pageState.favor, loadFavor);
        }

        function renderDmLogs(count) {
            const tbody = document.getElementById('dmBody'); tbody.innerHTML = '';
            if (dmData.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ DM</td></tr>'; return; }

            dmData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-800/50 transition-colors border-b border-gray-800 last:border-0";
                tr.innerHTML = `
            <td class="py-4 px-6 text-white font-medium">${item.session_name}</td>
            <td class="py-4 px-6 text-gray-500 text-xs whitespace-nowrap">${item.date ? new Date(item.date).toLocaleDateString('th-TH') : '-'}</td>
            <td class="py-4 px-6 text-gray-300 font-mono">${item.hours}</td>
            <td class="py-4 px-6 text-yellow-400 text-xs font-mono">+${item.auto_gold}</td>
            <td class="py-4 px-6 text-purple-400 text-xs font-mono">+${item.auto_favor}</td>
            <td class="py-4 px-6 text-center text-xs">
                ${item.solo_quest ? '<span class="text-blue-400 bg-blue-900/30 px-1.5 py-0.5 rounded border border-blue-800">Solo</span>' : ''}
                ${item.double_reward ? '<span class="text-green-400 bg-green-900/30 px-1.5 py-0.5 rounded border border-green-800">x2</span>' : ''}
            </td>
            <td class="py-4 px-6 text-center">
                <div class="flex justify-center gap-2">
                    <button onclick="editDmLog('${item.id}')" class="text-gray-500 hover:text-yellow-400 transition p-1"><i class="fa-solid fa-pen"></i></button>
                    <button onclick="deleteDmLog('${item.id}')" class="text-gray-500 hover:text-red-400 transition p-1"><i class="fa-solid fa-trash"></i></button>
                </div>
            </td>`;
                tbody.appendChild(tr);
            });
            renderPaginationUI('dmPagination', count, pageState.dm, loadDmLogs);
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('active', 'text-white');
            });

            const tabContent = document.getElementById(tabName);
            if (tabContent) tabContent.classList.add('active');

            const btn = document.getElementById('tab-' + tabName);
            if (btn) {
                btn.classList.add('active', 'text-white');
                btn.classList.remove('text-gray-400');

                // Color coding active tabs
                if (tabName === 'gold') btn.classList.add('text-yellow-400');
                else if (tabName === 'favor') btn.classList.add('text-purple-400');
                else if (tabName === 'dm') btn.classList.add('text-red-400');
                else if (tabName === 'char-notes') btn.classList.add('text-blue-400');
            }
        }

        async function manualRefresh() {
            const btn = document.getElementById('btnRefresh');
            const icon = document.getElementById('refreshIcon'); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡πà‡∏≤‡∏ô ID ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Å‡∏ß‡πà‡∏≤

            // ‡πÉ‡∏ä‡πâ class 'animate-spin' ‡∏Ç‡∏≠‡∏á Tailwind ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            icon.classList.add('animate-spin', 'text-white');
            btn.classList.add('cursor-wait', 'opacity-70', 'bg-gray-800'); // ‡∏•‡πá‡∏≠‡∏Ñ‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°
            btn.disabled = true;

            try {
                // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏∏‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ + ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
                await Promise.all([
                    refreshAllData(),
                    new Promise(resolve => setTimeout(resolve, 1000))
                ]);

            } catch (error) {
                console.error("Refresh failed:", error);
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
            } finally {
                // ‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏°‡∏∏‡∏ô
                icon.classList.remove('animate-spin', 'text-white');
                btn.classList.remove('cursor-wait', 'opacity-70', 'bg-gray-800');
                btn.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => { openTab('session'); });

        // --- Bulk Session Import ---
        let bulkParsedSessions = [];

        function openBulkImportModal() {
            document.getElementById('bulkImportModal').classList.remove('hidden');
            document.getElementById('bulkImportModal').classList.add('flex');
            document.getElementById('bulkTextarea').value = '';
            document.getElementById('bulkPreview').innerHTML = '';
            document.getElementById('bulkStatus').textContent = '';
            document.getElementById('btnBulkSaveWrap').classList.add('hidden');
            document.getElementById('btnBulkSave').disabled = false;
            document.getElementById('btnBulkSave').innerHTML = '<i class="fa-solid fa-save mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            bulkParsedSessions = [];
        }

        function closeBulkImportModal() {
            document.getElementById('bulkImportModal').classList.add('hidden');
            document.getElementById('bulkImportModal').classList.remove('flex');
            document.getElementById('btnBulkSaveWrap').classList.add('hidden');
            document.getElementById('btnBulkSave').disabled = false;
            document.getElementById('btnBulkSave').innerHTML = '<i class="fa-solid fa-save mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            bulkParsedSessions = [];
        }

        function parseBulkSessions() {
            const raw = document.getElementById('bulkTextarea').value.trim();
            if (!raw) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô');

            const lines = raw.split('\n').filter(l => l.trim());
            bulkParsedSessions = [];
            const errors = [];

            lines.forEach((line, idx) => {
                const cols = line.split('\t');
                if (cols.length < 4) {
                    errors.push(`‡πÅ‡∏ñ‡∏ß ${idx + 1}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)`);
                    return;
                }

                const name = cols[0]?.trim();
                const dm = cols[1]?.trim() || '';
                const rawDate = cols[2]?.trim() || '';
                const hours = parseFloat(cols[3]?.trim()) || 0;
                const gotItems = cols[4]?.trim() || '';

                if (!name) {
                    errors.push(`‡πÅ‡∏ñ‡∏ß ${idx + 1}: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠ Session`);
                    return;
                }

                // Parse date: DD/MM/YYYY or D/M/YYYY ‚Üí YYYY-MM-DD
                let dateFormatted = null;
                if (rawDate) {
                    const parts = rawDate.split('/');
                    if (parts.length === 3) {
                        const day = parts[0].padStart(2, '0');
                        const month = parts[1].padStart(2, '0');
                        let year = parts[2];
                        // Handle Buddhist Era (‡∏û.‡∏®.) ‚Üí convert to CE
                        if (parseInt(year) > 2500) year = String(parseInt(year) - 543);
                        dateFormatted = `${year}-${month}-${day}`;
                    }
                }

                bulkParsedSessions.push({ name, dm, date: dateFormatted, hours, gotItems, rawDate });
            });

            // Render preview
            const previewEl = document.getElementById('bulkPreview');
            if (errors.length > 0) {
                previewEl.innerHTML = `<div class="text-red-400 text-sm mb-3"><i class="fa-solid fa-triangle-exclamation mr-1"></i> ${errors.join('<br>')}</div>`;
            }

            if (bulkParsedSessions.length === 0) {
                previewEl.innerHTML += '<p class="text-gray-500 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>';
                document.getElementById('btnBulkSaveWrap').classList.add('hidden');
                return;
            }

            let tableHtml = `
                <div class="overflow-x-auto rounded-xl border border-gray-700 mb-3">
                    <table class="min-w-full text-sm text-gray-300">
                        <thead class="bg-gray-800/80 text-gray-400 uppercase text-[10px] font-bold tracking-wider">
                            <tr>
                                <th class="py-2 px-3">#</th>
                                <th class="py-2 px-3">‡∏ä‡∏∑‡πà‡∏≠ Session</th>
                                <th class="py-2 px-3">DM</th>
                                <th class="py-2 px-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="py-2 px-3">Hrs</th>
                                <th class="py-2 px-3">‡πÑ‡∏≠‡πÄ‡∏ó‡∏°/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-800">`;

            bulkParsedSessions.forEach((s, i) => {
                tableHtml += `
                    <tr class="hover:bg-gray-800/40">
                        <td class="py-2 px-3 text-gray-500">${i + 1}</td>
                        <td class="py-2 px-3 text-white font-medium">${s.name}</td>
                        <td class="py-2 px-3 text-gray-400">${s.dm || '-'}</td>
                        <td class="py-2 px-3 text-gray-400 whitespace-nowrap">${s.rawDate || '-'}</td>
                        <td class="py-2 px-3 text-gray-300 font-mono">${s.hours}</td>
                        <td class="py-2 px-3 text-gray-400 max-w-[200px] truncate">${s.gotItems || '-'}</td>
                    </tr>`;
            });

            tableHtml += '</tbody></table></div>';

            previewEl.innerHTML += tableHtml;
            previewEl.innerHTML += `<p class="text-sm text-emerald-400"><i class="fa-solid fa-check-circle mr-1"></i> ‡∏û‡∏ö ${bulkParsedSessions.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>`;
            document.getElementById('btnBulkSaveWrap').classList.remove('hidden');
        }

        async function saveBulkSessions() {
            if (bulkParsedSessions.length === 0) return;

            const btn = document.getElementById('btnBulkSave');
            if (btn.disabled) return; // prevent double-click

            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${bulkParsedSessions.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) return;

            const statusEl = document.getElementById('bulkStatus');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            const c = currentCharData || {};
            let cumulativeHours = 0;
            const payloads = [];

            for (const s of bulkParsedSessions) {
                const currentTotalHours = (Number(c.total_sessions_hours) || 0) + (Number(c.total_dm_hours) || 0) + cumulativeHours;
                const projectedTotalHours = currentTotalHours + s.hours;
                const { level: projectedLevel } = calculateCurrentLevel(c.level, projectedTotalHours);
                const multiplier = getGoldMultiplier(projectedLevel);
                const autoGold = Math.floor(s.hours * 100 * multiplier);
                const autoFavor = Math.floor(s.hours * 2);

                payloads.push({
                    character_id: currentCharId,
                    user_id: currentUser.id,
                    name: s.name,
                    dm: s.dm,
                    date: s.date,
                    hours: s.hours,
                    notes: '',
                    no_gold: false,
                    auto_gold: autoGold,
                    auto_favor: autoFavor,
                    got_items: s.gotItems
                });

                cumulativeHours += s.hours;
            }

            const { error } = await supabase.from('sessions').insert(payloads);

            if (error) {
                statusEl.innerHTML = `<span class="text-red-400"><i class="fa-solid fa-xmark mr-1"></i> Error: ${error.message}</span>`;
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-save mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            } else {
                statusEl.innerHTML = `<span class="text-emerald-400"><i class="fa-solid fa-check-circle mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${payloads.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£!</span>`;
                setTimeout(() => {
                    closeBulkImportModal();
                    refreshAllData();
                }, 1200);
            }
        }
    </script>

    <!-- Bulk Import Modal -->
    <div id="bulkImportModal"
        class="hidden fixed inset-0 z-50 items-center justify-center bg-black/70 backdrop-blur-sm p-4"
        onclick="if(event.target===this)closeBulkImportModal()">
        <div
            class="glass-panel rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-6 relative animate-fadeIn border border-indigo-500/20">
            <button onclick="closeBulkImportModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-white transition p-1">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>

            <h2 class="text-lg font-bold text-white flex items-center gap-2 mb-1">
                <span class="bg-indigo-600/20 text-indigo-400 p-1.5 rounded-lg text-sm"><i
                        class="fa-solid fa-clipboard-list"></i></span>
                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Session ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            </h2>
            <p class="text-xs text-gray-500 mb-5">‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets / Excel (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Tab)</p>

            <div class="bg-gray-900/50 rounded-xl p-3 mb-4 border border-gray-800">
                <p class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-2"><i
                        class="fa-solid fa-info-circle mr-1"></i> ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Tab-separated)</p>
                <code
                    class="text-xs text-indigo-300 block leading-relaxed">‡∏ä‡∏∑‡πà‡∏≠ Session &nbsp; ‚Üπ &nbsp; ‡∏ä‡∏∑‡πà‡∏≠ DM &nbsp; ‚Üπ &nbsp; ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (D/M/YYYY) &nbsp; ‚Üπ &nbsp; ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á &nbsp; ‚Üπ &nbsp; ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</code>
                <p class="text-[10px] text-gray-600 mt-2">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏£‡πâ‡∏ô‡∏≤‡∏° ‚Üπ DM Jimmy ‚Üπ
                    17/7/2025 ‚Üπ 5 ‚Üπ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö Memory Sigil</p>
            </div>

            <textarea id="bulkTextarea" rows="8"
                class="w-full p-3 rounded-xl input-primary text-sm font-mono resize-none mb-4"
                placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheet ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà... (‡πÅ‡∏ï‡πà‡∏•‡∏∞ Session 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)"></textarea>

            <div class="mb-4">
                <button type="button" onclick="parseBulkSessions()"
                    class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold px-5 py-2 rounded-xl shadow-lg shadow-indigo-600/20 transition-all hover:-translate-y-0.5 text-sm">
                    <i class="fa-solid fa-magnifying-glass mr-1"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>

            <div id="bulkPreview" class="mb-3"></div>
            <div id="bulkStatus" class="text-sm mb-3"></div>

            <div id="btnBulkSaveWrap" class="hidden">
                <button type="button" id="btnBulkSave" onclick="saveBulkSessions()"
                    class="bg-emerald-600 hover:bg-emerald-500 text-white font-semibold px-5 py-2.5 rounded-xl shadow-lg shadow-emerald-600/20 transition-all hover:-translate-y-0.5 text-sm w-full">
                    <i class="fa-solid fa-save mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
        </div>
    </div>
    <!-- Edit Character Modal -->
    <div id="editCharModal"
        class="hidden fixed inset-0 z-50 items-center justify-center bg-black/70 backdrop-blur-sm p-4"
        onclick="if(event.target===this)closeEditCharacterModal()">
        <div
            class="glass-panel rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto p-6 relative animate-fadeIn border border-amber-500/20">
            <button type="button" onclick="closeEditCharacterModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-white transition p-1">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>

            <h2 class="text-lg font-bold text-white flex items-center gap-2 mb-5">
                <span class="bg-amber-500/20 text-amber-400 p-1.5 rounded-lg text-sm"><i
                        class="fa-solid fa-pen-to-square"></i></span>
                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
            </h2>

            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-500 ml-1 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ <span
                            class="text-red-400">*</span></label>
                    <input id="editCharName" class="w-full p-2.5 rounded-xl input-primary" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£" />
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-500 ml-1 mb-1 block">‡∏≠‡∏≤‡∏ä‡∏µ‡∏û (Class)</label>
                        <input id="editCharClass" class="w-full p-2.5 rounded-xl input-primary"
                            placeholder="‡πÄ‡∏ä‡πà‡∏ô Fighter, Wizard..." />
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 ml-1 mb-1 block">‡πÄ‡∏ú‡πà‡∏≤ (Race)</label>
                        <input id="editCharRace" class="w-full p-2.5 rounded-xl input-primary"
                            placeholder="‡πÄ‡∏ä‡πà‡∏ô Human, Elf..." />
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-500 ml-1 mb-1 block">Alignment</label>
                        <select id="editCharAlignment" class="w-full p-2.5 rounded-xl input-primary">
                            <option value="">- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ -</option>
                            <option value="Chaotic Evil">Chaotic Evil</option>
                            <option value="Chaotic Good">Chaotic Good</option>
                            <option value="Chaotic Neutral">Chaotic Neutral</option>
                            <option value="Lawful Evil">Lawful Evil</option>
                            <option value="Lawful Good">Lawful Good</option>
                            <option value="Lawful Neutral">Lawful Neutral</option>
                            <option value="Neutral">Neutral</option>
                            <option value="Neutral Evil">Neutral Evil</option>
                            <option value="Neutral Good">Neutral Good</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 ml-1 mb-1 block">‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á (Companion)</label>
                        <input id="editCharPets" class="w-full p-2.5 rounded-xl input-primary"
                            placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á" />
                    </div>
                </div>

                <div>
                    <label class="text-xs text-gray-500 ml-1 mb-1 block">Sheet Link</label>
                    <input id="editCharSheetLink" class="w-full p-2.5 rounded-xl input-primary"
                        placeholder="https://..." />
                </div>

                <!-- Admin-only fields -->
                <div id="editCharAdminFields" class="hidden border-t border-gray-700/50 pt-4 mt-2">
                    <p
                        class="text-[10px] text-amber-400/80 uppercase font-bold tracking-wider mb-3 flex items-center gap-1.5">
                        <i class="fa-solid fa-shield-halved"></i> Admin Only
                    </p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-500 ml-1 mb-1 block">‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                            <input id="editCharLevel" type="number" min="1" max="30"
                                class="w-full p-2.5 rounded-xl input-primary" placeholder="1" />
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 ml-1 mb-1 block">‡∏ó‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (GP)</label>
                            <input id="editCharGoldStart" type="number" min="0"
                                class="w-full p-2.5 rounded-xl input-primary" placeholder="0" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button type="button" id="btnSaveEditChar" onclick="saveEditCharacter()"
                    class="flex-1 bg-amber-600 hover:bg-amber-500 text-white font-semibold px-6 py-2.5 rounded-xl shadow-lg shadow-amber-600/20 transition-all hover:-translate-y-0.5">
                    <i class="fa-solid fa-save mr-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button type="button" onclick="closeEditCharacterModal()"
                    class="bg-gray-700 hover:bg-gray-600 text-white font-medium px-6 py-2.5 rounded-xl transition">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

</body>

</html>