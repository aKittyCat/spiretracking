<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="env.js"></script>
    <script src="supabase-config.js"></script>
    <title>The Spire Tracking - ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #111827;
        }

        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }

        .glass-panel {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(75, 85, 99, 0.4);
        }

        .gradient-text {
            background: linear-gradient(to right, #c084fc, #818cf8);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Input Autofill Fix for Dark Mode */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #1f2937 inset !important;
            -webkit-text-fill-color: white !important;
            transition: background-color 5000s ease-in-out 0s;
        }
    </style>
</head>

<body class="bg-gray-950 text-gray-200 min-h-screen selection:bg-purple-500 selection:text-white">

    <div class="max-w-[1280px] mx-auto p-4 sm:p-6 lg:p-8">

        <div class="flex flex-col md:flex-row justify-between items-center mb-8 pb-6 border-b border-gray-800 gap-4">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-gray-800 rounded-xl shadow-lg border border-gray-700">
                    <span class="text-2xl">üßô‚Äç‚ôÇÔ∏è</span>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-white tracking-tight">
                        ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á <span class="gradient-text">‡∏â‡∏±‡∏ô</span>
                    </h1>
                    <p class="text-xs text-gray-500 mt-1">Manage your characters</p>
                </div>
            </div>

            <div class="flex items-center gap-3 bg-gray-900/50 p-2 rounded-xl border border-gray-800">
                <div class="px-3 flex flex-col items-end">
                    <span class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Logged in as</span>
                    <span id="userEmail" class="text-sm font-medium text-gray-300">Loading...</span>
                </div>
                <button onclick="logout()"
                    class="bg-rose-600/10 hover:bg-rose-600 text-rose-500 hover:text-white p-2 rounded-lg transition-all duration-300 border border-rose-600/20"
                    title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" x2="9" y1="12" y2="12" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="flex flex-wrap gap-3 mb-8 justify-center sm:justify-start">
            <button id="adminBtn" style="display:none" onclick="location.href='dashboard.html'"
                class="glass-panel hover:bg-purple-600/20 text-purple-300 hover:text-purple-200 border-purple-500/30 px-5 py-2.5 rounded-xl shadow-lg transition-all duration-200 text-sm font-semibold flex items-center gap-2 group">
                <span>‚öôÔ∏è</span> Admin Dashboard
            </button>

            <div class="h-10 w-[1px] bg-gray-800 hidden sm:block mx-1"></div>

            <button onclick="window.open('https://spireform.vercel.app/', '_blank')"
                class="glass-panel hover:bg-gray-800 text-gray-300 px-5 py-2.5 rounded-xl shadow transition-all duration-200 text-sm font-medium flex items-center gap-2 hover:-translate-y-0.5">
                üìù ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
            </button>
            <button onclick="window.open('https://spiremk.vercel.app/', '_blank')"
                class="glass-panel hover:bg-gray-800 text-gray-300 px-5 py-2.5 rounded-xl shadow transition-all duration-200 text-sm font-medium flex items-center gap-2 hover:-translate-y-0.5">
                üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
            </button>
            <button onclick="window.location.href = 'glass_arboretum.html'"
                class="glass-panel hover:bg-gray-800 text-gray-300 px-5 py-2.5 rounded-xl shadow transition-all duration-200 text-sm font-medium flex items-center gap-2 hover:-translate-y-0.5">
                üß™ Glass Arboretum
            </button>
            <button onclick="window.location.href = 'piety_deities.html'"
                class="glass-panel hover:bg-gray-800 text-gray-300 px-5 py-2.5 rounded-xl shadow transition-all duration-200 text-sm font-medium flex items-center gap-2 hover:-translate-y-0.5">
                ‚õ™ Piety
            </button>
            <button onclick="window.location.href = 'lore.html'"
                class="glass-panel hover:bg-gray-800 text-gray-300 px-5 py-2.5 rounded-xl shadow transition-all duration-200 text-sm font-medium flex items-center gap-2 hover:-translate-y-0.5">
                üì∞ Lore
            </button>
        </div>

        <div class="glass-panel rounded-2xl shadow-xl mb-10 border-t-4 border-t-blue-500/50 overflow-hidden">
            <button onclick="toggleAddForm()"
                class="w-full p-6 pb-5 flex items-center justify-between cursor-pointer hover:bg-white/5 transition-colors">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">
                    <span class="bg-blue-500/20 text-blue-400 p-1.5 rounded-lg text-sm">‚úö</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà
                </h2>
                <i id="addFormChevron" class="fa-solid fa-chevron-down text-gray-400"
                    style="transform: rotate(-90deg);"></i>
            </button>

            <div id="addFormContent" class="px-6"
                style="max-height: 0px; opacity: 0; overflow: hidden; padding-top: 0; padding-bottom: 0;">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-4">
                    <div class="md:col-span-4">
                        <label class="block text-xs text-gray-500 mb-1 ml-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</label>
                        <input id="charName" placeholder="Name"
                            class="w-full px-4 py-2.5 rounded-xl bg-gray-800 border border-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition placeholder-gray-600" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs text-gray-500 mb-1 ml-1">‡πÄ‡∏•‡πÄ‡∏ß‡∏•</label>
                        <input type="number" min="1" value="3" placeholder="Level"
                            class="w-full px-4 py-2.5 rounded-xl bg-gray-800 border border-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition placeholder-gray-600" />
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs text-gray-500 mb-1 ml-1">‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</label>
                        <input id="charClass" placeholder="Class"
                            class="w-full px-4 py-2.5 rounded-xl bg-gray-800 border border-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition placeholder-gray-600" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs text-gray-500 mb-1 ml-1">‡πÄ‡∏ú‡πà‡∏≤</label>
                        <input id="charRace" placeholder="Race"
                            class="w-full px-4 py-2.5 rounded-xl bg-gray-800 border border-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition placeholder-gray-600" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs text-gray-500 mb-1 ml-1">Alignment</label>
                        <select id="charAlignment"
                            class="w-full px-4 py-2.5 rounded-xl bg-gray-800 border border-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                            <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Alignment</option>
                            <option value="Chaotic Evil">Chaotic Evil</option>
                            <option value="Chaotic Good">Chaotic Good</option>
                            <option value="Chaotic Neutral">Chaotic Neutral</option>
                            <option value="Lawful Evil">Lawful Evil</option>
                            <option value="Lawful Good">Lawful Good</option>
                            <option value="Lawful Neutral">Lawful Neutral</option>
                            <option value="Neutral">Neutral</option>
                            <option value="Neutral Evil">Neutral Evil</option>
                            <option value="Neutral Good">Neutral Good</option>
                        </select>
                    </div>

                    <div class="md:col-span-3">
                        <label class="block text-xs text-gray-500 mb-1 ml-1">‡∏ó‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (GP)</label>
                        <input id="charGold" type="number" placeholder="0"
                            class="w-full px-4 py-2.5 rounded-xl bg-gray-800 border border-gray-700 text-white focus:ring-2 focus:ring-yellow-500 focus:border-transparent outline-none transition placeholder-gray-600 text-yellow-400" />
                    </div>
                    <div class="md:col-span-7">
                        <label class="block text-xs text-gray-500 mb-1 ml-1">‡∏•‡∏¥‡∏á‡∏Å‡πå Character Sheet</label>
                        <input id="sheetLink" placeholder="https://..."
                            class="w-full px-4 py-2.5 rounded-xl bg-gray-800 border border-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition placeholder-gray-600" />
                    </div>
                    <div class="md:col-span-2 flex items-end">
                        <button onclick="addCharacter()"
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold px-4 py-2.5 rounded-xl shadow-lg shadow-blue-600/20 transition-all hover:scale-[1.02] active:scale-95">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-6 flex justify-between items-center">
            <h3 class="text-xl font-semibold text-gray-300">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</h3>
            <button onclick="loadCharacters(currentPage)"
                class="text-xs text-gray-500 hover:text-white transition flex items-center gap-1">
                üîÑ Refresh
            </button>
        </div>

        <div id="charactersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-8">
            <div class="col-span-full py-12 text-center text-gray-500">
                <div
                    class="inline-block w-8 h-8 border-4 border-gray-600 border-t-blue-500 rounded-full animate-spin mb-2">
                </div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        </div>

        <div id="paginationControls" class="flex justify-center items-center space-x-2 py-4"></div>

        <footer class="mt-16 text-center text-xs text-gray-600 mb-8 border-t border-gray-800 pt-8">
            <p>&copy; üè∞ The Spire Tracking | Created by aKittyCatüêà. All rights reserved.</p>
        </footer>
    </div>

    <script src="/js/utils.js"></script>
    <script src="/js/fetch.js"></script>
    <script>
        let currentUser = null;
        const ITEMS_PER_PAGE = 9;
        let currentPage = 1;

        async function init() {
            if (typeof supabase === 'undefined') {
                alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Supabase Client! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå supabase-config.js');
                return;
            }

            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            currentUser = session.user;
            document.getElementById('userEmail').textContent = currentUser.email;

            checkAdmin();
            loadCharacters(1);
        }
        init();

        async function checkAdmin() {
            const { data } = await supabase.rpc('is_admin');
            if (data) document.getElementById('adminBtn').style.display = 'inline-flex';
        }

        async function addCharacter() {
            const name = document.getElementById('charName').value.trim();
            if (!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£');

            const btn = document.querySelector('button[onclick="addCharacter()"]');
            const originalText = btn.innerHTML;
            btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            btn.disabled = true;

            const { error } = await supabase.from('characters').insert({
                user_id: currentUser.id,
                name: name,
                level: document.getElementById('charLevel').value || 1,
                class: document.getElementById('charClass').value || 'Unknown',
                race: document.getElementById('charRace').value || 'Unknown',
                alignment: document.getElementById('charAlignment').value || '',
                gold_start: document.getElementById('charGold').value || 0,
                sheet_link: document.getElementById('sheetLink').value
            });

            if (error) {
                alert('Error: ' + error.message);
            } else {
                // Clear inputs
                document.querySelectorAll('input').forEach(i => i.value = '');
                document.getElementById('charLevel').value = 1;
                loadCharacters(1); // Reload
            }

            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        async function loadCharacters(page) {
            currentPage = page;

            // Loading State
            const list = document.getElementById('charactersList');
            list.innerHTML = `
        <div class="col-span-full py-20 text-center flex flex-col items-center justify-center text-gray-500">
            <div class="w-10 h-10 border-4 border-gray-700 border-t-blue-500 rounded-full animate-spin mb-4"></div>
            <p class="animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£...</p>
        </div>
      `;

            const from = (page - 1) * ITEMS_PER_PAGE;
            const { data, error } = await supabase.rpc('get_character_stats', {
                target_user_id: currentUser.id
            });

            if (error) {
                console.error('Load Error:', error);
                list.innerHTML = `<div class="col-span-full text-center text-red-400 py-10">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
                return;
            }

            // Sort: Name A-Z
            data.sort((a, b) => a.name.localeCompare(b.name));

            const totalItems = data.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            const paginatedData = data.slice(from, from + ITEMS_PER_PAGE);

            renderCharacters(paginatedData);
            renderPagination(totalPages, page);

            // Auto-collapse/expand add form based on character count
            const content = document.getElementById('addFormContent');
            const chevron = document.getElementById('addFormChevron');
            if (data.length === 0) {
                // Expand without animation on first load
                content.style.maxHeight = '500px';
                content.style.opacity = '1';
                content.style.overflow = 'visible';
                content.style.paddingBottom = '1.5rem';
                chevron.style.transform = 'rotate(0deg)';
            }
            // Enable transitions after initial state is set
            requestAnimationFrame(() => {
                content.classList.add('transition-all', 'duration-300', 'ease-in-out');
                chevron.classList.add('transition-transform', 'duration-300');
            });
        }

        function toggleAddForm() {
            const content = document.getElementById('addFormContent');
            const chevron = document.getElementById('addFormChevron');
            const isCollapsed = content.style.maxHeight === '0px';
            if (isCollapsed) {
                content.style.maxHeight = '500px';
                content.style.opacity = '1';
                content.style.overflow = 'visible';
                content.style.paddingBottom = '1.5rem';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                content.style.maxHeight = '0px';
                content.style.opacity = '0';
                content.style.overflow = 'hidden';
                content.style.paddingTop = '0';
                content.style.paddingBottom = '0';
                chevron.style.transform = 'rotate(-90deg)';
            }
        }

        function renderCharacters(characters) {
            const list = document.getElementById('charactersList');
            list.innerHTML = '';

            if (!characters || characters.length === 0) {
                list.innerHTML = `
            <div class="col-span-full py-16 text-center border-2 border-dashed border-gray-800 rounded-2xl">
                <p class="text-4xl mb-2">üìú</p>
                <p class="text-gray-400 text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</p>
                <p class="text-gray-600 text-sm mt-1">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</p>
            </div>
          `;
                return;
            }

            characters.forEach(c => {
                const totalHours = (Number(c.total_sessions_hours) || 0) + (Number(c.total_dm_hours) || 0);
                const { level: currentLevel } = calculateCurrentLevel(c.level || 1, totalHours);
                const firstLetter = c.name.charAt(0).toUpperCase();
                const tier = getTierFromLevel(currentLevel);
                const tierStyle = getTierStyle(tier);
                const alignmentStyle = getAlignmentStyle(c.alignment);
                const alignmentText = c.alignment || '-';
                const companionText = c.pets || 'None';

                // Avatar gradient based on tier
                const avatarGradient = {
                    'Tier 1': 'from-slate-500 to-slate-700',
                    'Tier 2': 'from-emerald-500 to-emerald-700',
                    'Tier 3': 'from-blue-500 to-blue-700',
                    'Tier 4': 'from-purple-500 to-purple-700',
                    'Tier 5': 'from-amber-400 to-amber-600'
                }[tier] || 'from-gray-500 to-gray-700';

                // Card Template - Enhanced Design
                list.innerHTML += `
          <div class="glass-panel rounded-2xl overflow-hidden group hover:shadow-2xl hover:shadow-indigo-500/10 transition-all duration-300 hover:-translate-y-1.5 border border-gray-700/50 hover:border-indigo-500/30 relative">
             
             <!-- Decorative gradient overlay -->
             <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-indigo-600/10 to-transparent rounded-full blur-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-500 -z-10"></div>
             
             <!-- Header Section -->
             <div class="p-5 pb-4 relative">
                <div class="flex items-start gap-4">
                    <!-- Avatar with tier-colored gradient -->
                    <div class="relative">
                        <div class="w-14 h-14 rounded-xl bg-gradient-to-br ${avatarGradient} flex items-center justify-center text-xl font-bold text-white shadow-lg group-hover:scale-105 transition-transform duration-300">
                            ${firstLetter}
                        </div>
                        <div class="absolute -bottom-1 -right-1 px-1.5 py-0.5 rounded text-[9px] font-bold uppercase border shadow-sm ${tierStyle}">
                            ${tier.replace('Tier ', 'T')}
                        </div>
                    </div>
                    
                    <!-- Character Info -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-start justify-between gap-2">
                            <div class="min-w-0">
                                <h3 class="font-bold text-lg text-white leading-tight truncate group-hover:text-indigo-200 transition-colors" title="${c.name}">${c.name}</h3>
                                <p class="text-xs text-gray-400 mt-0.5">${c.race || 'Unknown'} ¬∑ ${c.class || 'Adventurer'}</p>
                            </div>
                            <div class="flex-shrink-0 bg-gradient-to-br from-gray-800 to-gray-900 text-white text-sm font-bold px-3 py-1.5 rounded-xl border border-gray-600 shadow-lg">
                                <span class="text-indigo-300">Lv.</span> ${currentLevel}
                            </div>
                        </div>
                        
                        <!-- Tags Row -->
                        <div class="flex flex-wrap gap-1.5 mt-3">
                            <span class="px-2 py-0.5 rounded-md border text-[10px] font-medium ${alignmentStyle}">
                                ‚öñÔ∏è ${alignmentText}
                            </span>
                            ${companionText !== 'None' ? `
                            <span class="px-2 py-0.5 rounded-md bg-amber-500/10 border border-amber-500/30 text-amber-300 text-[10px] font-medium">
                                üêæ ${companionText}
                            </span>
                            ` : ''}
                        </div>
                    </div>
                </div>
             </div>

             <!-- Stats Section -->
             <div class="px-5 pb-4">
                <div class="grid grid-cols-2 gap-2">
                    <!-- Gold -->
                    <div class="bg-gradient-to-br from-yellow-900/20 to-transparent p-3 rounded-xl border border-yellow-500/20 group/stat hover:border-yellow-500/40 transition-colors">
                        <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1 flex items-center gap-1">
                            <span class="text-yellow-500">üí∞</span> Gold
                        </div>
                        <div class="text-yellow-400 font-mono font-bold text-lg leading-none">
                            ${(Number(c.total_gold) || 0).toLocaleString()}
                            <span class="text-[10px] text-yellow-600 ml-0.5">GP</span>
                        </div>
                    </div>
                    
                    <!-- Hours -->
                    <div class="bg-gradient-to-br from-green-900/20 to-transparent p-3 rounded-xl border border-green-500/20 group/stat hover:border-green-500/40 transition-colors">
                        <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1 flex items-center gap-1">
                            <span class="text-green-500">‚è±Ô∏è</span> Playtime
                        </div>
                        <div class="text-green-400 font-mono font-bold text-lg leading-none">
                            ${totalHours.toFixed(1)}
                            <span class="text-[10px] text-green-600 ml-0.5">hrs</span>
                        </div>
                    </div>
                </div>
             </div>

             <!-- Actions Section -->
             <div class="bg-gray-900/60 backdrop-blur-sm px-4 py-3 flex items-center gap-2 border-t border-gray-800/50">
                ${c.sheet_link ?
                        `<a href="${c.sheet_link}" target="_blank" class="flex-1 text-center py-2 rounded-lg bg-gray-800/80 text-gray-300 text-xs hover:bg-gray-700 hover:text-white transition-all font-medium flex items-center justify-center gap-1.5 border border-gray-700 hover:border-gray-600">
                        <span>üìÑ</span> Sheet
                    </a>`
                        : '<span class="flex-1"></span>'}
                
                <a href="character-detail.html?charId=${c.id}" class="flex-1 text-center py-2 rounded-lg bg-indigo-600/20 text-indigo-300 text-xs hover:bg-indigo-600 hover:text-white transition-all font-semibold flex items-center justify-center gap-1.5 border border-indigo-500/30 hover:border-indigo-500 hover:shadow-lg hover:shadow-indigo-500/20">
                    <span>üìã</span> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                </a>

                <button onclick="deleteChar('${c.id}')" class="p-2 rounded-lg text-gray-500 hover:bg-red-500/20 hover:text-red-400 transition-all border border-transparent hover:border-red-500/30" title="‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£">
                    üóëÔ∏è
                </button>
             </div>
          </div>
        `;
            });
        }

        function renderPagination(totalPages, currentPage) {
            const container = document.getElementById('paginationControls');
            container.innerHTML = '';
            if (totalPages <= 1) return;

            // Previous
            const prevBtn = document.createElement('button');
            prevBtn.innerText = '¬´';
            prevBtn.disabled = currentPage === 1;
            prevBtn.className = `w-8 h-8 rounded-lg text-sm font-medium transition flex items-center justify-center ${currentPage === 1 ? 'text-gray-600 cursor-not-allowed' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`;
            prevBtn.onclick = () => loadCharacters(currentPage - 1);
            container.appendChild(prevBtn);

            // Pages
            for (let i = 1; i <= totalPages; i++) {
                if (totalPages > 7 && Math.abs(currentPage - i) > 2 && i !== 1 && i !== totalPages) continue; // Logic ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤

                const btn = document.createElement('button');
                btn.innerText = i;
                btn.className = `w-8 h-8 rounded-lg text-sm font-medium transition flex items-center justify-center ${i === currentPage ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`;
                btn.onclick = () => loadCharacters(i);
                container.appendChild(btn);
            }

            // Next
            const nextBtn = document.createElement('button');
            nextBtn.innerText = '¬ª';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.className = `w-8 h-8 rounded-lg text-sm font-medium transition flex items-center justify-center ${currentPage === totalPages ? 'text-gray-600 cursor-not-allowed' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`;
            nextBtn.onclick = () => loadCharacters(currentPage + 1);
            container.appendChild(nextBtn);
        }

        async function deleteChar(id) {
            if (!confirm('‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ô‡∏µ‡πâ?\n‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ')) return;

            const { error } = await deleteCharacterAndData(id, true);

            if (error) {
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } else {
                // alert('‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); // ‡∏ï‡∏±‡∏î Alert ‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Smooth ‡∏Ç‡∏∂‡πâ‡∏ô
                loadCharacters(currentPage);
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        // Helper
        const LEVEL_HOURS = [0, 0, 3.5, 10.5, 21, 35, 52.5, 73.5, 98, 126, 157.5, 192.5, 231, 273, 318.5, 367.5, 420, 476, 535.5, 598.5, 665, 735, 808.5, 885.5, 966, 1050, 1137.5, 1228.5, 1323, 1421, 1522.5, 0];
        function calculateCurrentLevel(start, hours) {
            let lvl = start;
            const total = (LEVEL_HOURS[start] || 0) + hours;
            for (let i = start + 1; i <= 30; i++) { if (total >= LEVEL_HOURS[i]) lvl = i; else break; }
            return { level: lvl };
        }

        function getTierFromLevel(level) {
            if (level >= 23) return "Tier 5";
            if (level >= 17) return "Tier 4";
            if (level >= 11) return "Tier 3";
            if (level >= 5) return "Tier 2";
            return "Tier 1";
        }

        function getTierStyle(tier) {
            switch (tier) {
                case 'Tier 1': return 'bg-slate-600/80 text-slate-200 border-slate-500';
                case 'Tier 2': return 'bg-emerald-600/80 text-emerald-100 border-emerald-500';
                case 'Tier 3': return 'bg-blue-600/80 text-blue-100 border-blue-500';
                case 'Tier 4': return 'bg-purple-600/80 text-purple-100 border-purple-500';
                case 'Tier 5': return 'bg-amber-500/80 text-amber-100 border-amber-400';
                default: return 'bg-gray-800/80 text-gray-300 border-gray-600';
            }
        }

        function getAlignmentStyle(alignment) {
            const al = (alignment || '').toLowerCase();
            if (al.includes('good')) return 'bg-emerald-500/20 border-emerald-500/50 text-emerald-300';
            if (al.includes('evil')) return 'bg-red-500/20 border-red-500/50 text-red-300';
            if (al.includes('lawful')) return 'bg-blue-500/20 border-blue-500/50 text-blue-300';
            if (al.includes('chaotic')) return 'bg-purple-500/20 border-purple-500/50 text-purple-300';
            return 'bg-gray-700/50 border-gray-600 text-gray-300';
        }
    </script>
</body>

</html>